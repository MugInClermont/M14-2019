image: google/cloud-sdk:alpine

stages:
  - configure
  - deploy
  
configure_backend: 
  stage: configure
  environment: Production
  only:
    refs:
     - master
    changes:
     - src/backend/*
  script:
  - echo Setting MongoDb adress $MONGODB_IP
  - sed -i  "s/localhost:27017/$MONGODB_IP:27017/" src/backend/config/default.yaml
  - cat src/backend/config/default.yaml
  - sed -i  "s/port: 3000/port: 443/" src/backend/config/default.yaml
  - cat src/backend/config/default.yaml
  
deploy_backend:
  stage: deploy
  environment: Production
  only:
    refs:
     - master
    changes:
     - src/backend/*
  script:
  - echo $SERVICE_ACCOUNT > /tmp/$CI_PIPELINE_ID.json
  - gcloud auth activate-service-account --key-file /tmp/$CI_PIPELINE_ID.json
  - rm /tmp/$CI_PIPELINE_ID.json
  - gcloud --quiet --project $PROJECT_ID app deploy src/backend/app.yaml

deploy_frontend:
  stage: deploy
  environment: Production
  only:
    refs:
     - master
    changes:
     - src/frontend/*
  script:
  - echo $SERVICE_ACCOUNT_frontend > /tmp/$CI_PIPELINE_ID.json
  - gcloud auth activate-service-account --key-file /tmp/$CI_PIPELINE_ID.json
  - rm /tmp/$CI_PIPELINE_ID.json
  - gcloud --quiet --project $PROJECT_ID app deploy src/frontend/app.yaml